<!DOCTYPE html>
<meta charset="utf-8">
<title>SANKEY Experiment</title>
<style>
 
.node circle {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}
 
.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}
 
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}
 
.link:hover {
  stroke-opacity: .5;
}

.axis line, .axis path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.domain {
  opacity: 0.4;
}

.x {  
  opacity: 0.6;
}

.axis text {
    text-shadow: 0 1px 0 #fff;
    cursor: move;
}
 
</style>
<body>
 
<p id="chart">
 
<link href="tipsy.css" rel="stylesheet" type="text/css" />
<link href="callout-styles.css" rel="stylesheet" type="text/css" />
<link href="meta-card-styles.css" rel="stylesheet" type="text/css" />
<link href="bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<script src="http://d3js.org/d3.v3.js"></script>
<script src="sankey.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="jquery.tipsy.js"></script>
<script>
  
var units = "Widgets";
 
var margin = {top: 10, right: 10, bottom: 10, left: 10},
    width = 1200 - margin.left - margin.right,
    height = 740 - margin.top - margin.bottom;
 
var formatNumber = d3.format(",.0f"),    // zero decimal places
    format = function(d) { return formatNumber(d) + " " + units; },
    color = d3.scale.category20();
 
// append the svg canvas to the page
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", 
          "translate(" + margin.left + "," + margin.top + ")");
 
// Set the sankey diagram properties
var sankey = d3.sankey()
    .nodeWidth(6)
    .nodePadding(10)
    .size([width, height-margin.top])
    .topMargin(3 * margin.top);
 
var path = sankey.link();
 
// load the data
d3.json("2k-links-modified.json", function(graph) {
 
    var nodeMap = {};
    graph.nodes.forEach(function(x) { nodeMap[x.uid] = x; });
    graph.links = graph.links.map(function(x) {
      return {
        source: nodeMap[x.source],
        target: nodeMap[x.target],
        value: x.value
      };
    });
 
  sankey
      .nodes(graph.nodes)
      .links(graph.links)
      .layout(32);
 
// add in the links
  var link = svg.append("g").selectAll(".link")
      .data(graph.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .on("click", function(d) {
        showEdgeInfo(d);
      })
      .style("stroke-width", 2/*function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; }*/);
 
// add the link titles
  link.append("title")
        .text(function(d) {
        return d.source.description + " â†’ " + 
                d.target.description + "\n" + format(d.value); });
 
// add in the nodes
  var node = svg.append("g").selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("id", function(d) { return "node_" + d.uid} )
      .attr("created_at", function(d) { return d.created_at; })
      .attr("transform", function(d) { 
      return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { 
      this.parentNode.appendChild(this); })
      .on("drag", dragmove));
 
// add the circles for the nodes
  node.append("circle")
      // .attr("height", function(d) { return d.dy; })
      .attr("r", sankey.nodeWidth())
      .style("fill", function(d) { 
      return d.color = color(d.uid.replace(/ .*/, "")); })
      .style("stroke", function(d) { 
      return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { 
      return d.uid + "\n" + format(d.value); });
 
// // add in the title for the nodes
//   var tooltip = node.append("text")
//       .attr("x", -6)
//       .attr("y", function(d) { return d.dy / 2; })
//       .attr("dy", ".35em")
//       .attr("text-anchor", "end")
//       .attr("transform", null)
//       .attr("id", function(d) { return "text_" + d.uid; })
//       .text(function(d) { return d.description; })
//       .style("visibility", "hidden")
//     .filter(function(d) { return d.x < width / 2; })
//       .attr("x", 6 + sankey.nodeWidth())
//       .attr("text-anchor", "start");

  // node.on('mouseover', function(d) {
  //   console.log(d3.select(this).select('#text_' + d.uid))
  //   var nodeSelection = d3.select(this).select('#text_' + d.uid).style("visibility", "visible");
  // });

  // node.on('mouseout', function(d) {
  //   var nodeSelection = d3.select(this).select('#text_' + d.uid).style("visibility", "hidden");
  // });

  $("svg circle").tipsy({
    gravity: 'w',
    html: true,
    title: function() {
      var d = this.__data__;
      return (
        "<span class='callout-text'>" + 
          "<span class='attr-name'> NAME: </span>" + d.description +
          "<br><br>\
          <span class='attr-name'> DATE: </span>" + d.created_at +
          "<span class='attr-name'> DATE: </span>\
          hello" + 
        "</span>"
      );
    }
  });

/* move nodes to timeline position. */

  function stringToDate(str) {
    return new Date(Date.parse(str));
  }

  var savedCoordinates = sankey.nodes().map(function(d) {
    return { x : d.x, y : d.y}
  });

  Array.prototype.maxDate = function() {
    return stringToDate(this.reduce(function (p, v) {
      return stringToDate(p.created_at) > stringToDate(v.created_at) ? p : v;
    }).created_at);
  };

  Array.prototype.minDate = function() {
    return stringToDate(this.reduce(function (p, v) {
      return stringToDate(p.created_at) < stringToDate(v.created_at) ? p : v;
    }).created_at);
  };

  var startDate = sankey.nodes().minDate();
  var endDate = sankey.nodes().maxDate();

  // find ms : px ratio
  var timeDiff = Math.abs(startDate.getTime() - endDate.getTime());
  var screenWidth = width - sankey.nodeWidth();
  var timeToSizeRatio = timeDiff / screenWidth;

  var newCoordinates = sankey.nodes().map(function(d) {
    var oldX = d.x;
    var newX = (stringToDate(d.created_at).getTime() - startDate.getTime())  / timeToSizeRatio;
  
    d3.select('#node_' + d.uid).attr("transform", 
        "translate(" + (d.x = newX) + "," + (d.y = Math.max(margin.top, Math.min(d.y))) + ")");
    sankey.relayout();
    link.attr("d", path);
    return newX;
  });

// vertical gridlines / x axis 
  var xScale = d3.time.scale()
        .domain([startDate, endDate])
        .range([0, width]);

  var xAxis = d3.svg.axis()
        .orient("top")
        // to change format: https://github.com/d3/d3/wiki/Time-Formatting
        .tickFormat(d3.time.format('%m/%y')) 
        .scale(xScale);

  svg.append("g")
        .attr("transform", "translate(0," + 20 + ")")
        .call(xAxis);

  svg.selectAll(".xAxis text")
        .attr("transform", function(d) {
            return "translate(" + this.getBBox().height*-2 + "," + this.getBBox().height + ")rotate(-45)";
        })

  svg.selectAll("line.x")
        .data(xScale.ticks(8))
        .enter().append("line")
        .attr("class", "x")
        .attr("x1", xScale)
        .attr("x2", xScale)
        .attr("y1", 0)
        .attr("y2", height)
        .style("stroke", "#ccc");

 
// the function for moving the nodes
  function dragmove(d) {
    d3.select(this).attr("transform", 
        "translate(" + (
             d.x = d.x
          ) + "," + (
                   d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
            ) + ")");
    sankey.relayout();
    link.attr("d", path);
  }

// update card after clicking on a link
  var parent = $("#detail-parent");
  var child = $("#detail-child");

// hard coded dummy data
  var TEMP_SOURCE_CODE = "1 no\n2 yes\n3 yes\n4 yes\n5 yes\n6 yes\n7 no\n8 no\n9 yes\n10 yes\n11 yes\n12 no";
  var TEMP_TARGET_CODE = "1 no\n2 no\n3 no\n4 no\n5 no\n6 yes\n7 yes\n8 yes\n9 yes\n10 yes\n11 no\n12 no\n13 yes\n14 yes\n15 yes\n16 no\n17 no\n";


  var TEMP_CODE_MATCH = [
    {"source_start_line": 2, "source_end_line": 6, "source_confidence": 69, "target_end_line": 10, "target_start_line": 6, "target_confidence": 82},
    {"source_start_line": 9, "source_end_line": 11, "source_confidence": 69, "target_end_line": 15, "target_start_line": 13, "target_confidence": 82}
  ];

  var TEMP_EDGE = {
    "source": {
      "code": TEMP_SOURCE_CODE,
      "created_at": "Date_B"
    },
    "target": {
      "code": TEMP_TARGET_CODE,
      "created_at": "Date_A"
    },
    "matches": TEMP_CODE_MATCH
  }

  // Outputs html for code, highlighting matches in red.
  function generateCodeHtml(lines, startDivs, endDivs) {
    var emptySpan = "<span> </span>"
    var newHtml = $("<div class='full-width'> </div>");
    var currentElement = $(emptySpan);
    for (var i = 0; i < lines.length; i++) {
      if (i+1 in startDivs) {
        newHtml.append(currentElement);
        currentElement = $("<div class='match match-" + startDivs[i+1] + "'> </div>");
        currentElement.hover(highlight, removeHighlight);
      }

      var newLine = $("<div class='full-width'> </div>");
      newLine.text(lines[i]);
      currentElement.append(newLine);

      if (i+1 in endDivs) {
        newHtml.append(currentElement);
        currentElement = $(emptySpan);
      }
    }
    newHtml.append(currentElement);
    return newHtml;
  }

  // updates the code snippets in the code comparison card
  function updateCode(link) {
    var parentNode = link.source;
    var childNode = link.target;

    var sourceLines = parentNode.code.split(/\n/);
    var targetLines = childNode.code.split(/\n/);
    var newSourceStartDivs = {};
    var newSourceEndDivs = {};
    var newTargetStartDivs = {};
    var newTargetEndDivs = {};

    newSourceStartDivs["count"] = 0;
    for (var i = 0; i < link.matches.length; i++) {
      var match = link.matches[i];
      var matchNumber = newSourceStartDivs["count"]++;

      newSourceStartDivs[match.source_start_line] = matchNumber;
      newSourceEndDivs[match.source_end_line] = matchNumber;

      newTargetStartDivs[match.target_start_line] = matchNumber;
      newTargetEndDivs[match.target_end_line] = matchNumber;
    }

    parent.find(".code-snippet").html(generateCodeHtml(sourceLines, newSourceStartDivs, newSourceEndDivs));
    child.find(".code-snippet").html(generateCodeHtml(targetLines, newTargetStartDivs, newTargetEndDivs));
  }

  // swaps source and target if an edge is in the wrong order
  function ensureLinkIsDirected(link) {
    var source = link.source;
    var target = link.target;

    if (link.source.created_at > link.target.created_at) {
      console.log("swapping");
      var temp = link.source;
      link.source = link.target;
      link.target = temp;
    }
  }

  // updates the code comparison card for a given edge.
  function showEdgeInfo(link) {
    ensureLinkIsDirected(link);
    var parentNode = link.source;
    var childNode = link.target;

    parent.find(".snippet-name").text(parentNode.description)
    parent.find(".author").text(parentNode.uid)
    parent.find(".created-date").text(parentNode.created_at)

    child.find(".snippet-name").text(childNode.description)
    child.find(".author").text(childNode.uid)
    child.find(".created-date").text(childNode.created_at)

    // TODO: replace this with a real edge, that includes real code and line numbers.
    updateCode(TEMP_EDGE);
  }

  // highlight a specific code match (on hover) using hoveree's class
  function highlight(e) {
    var matchingLines = $("." + e.currentTarget.className.split(" ").join("."));

    $(matchingLines).each(function() {
      $(this).css("background-color", "lightgray");
    })
  }

  // remove highlight after hover ends
  function removeHighlight(e) {
    var matchingLines = $("." + e.currentTarget.className.split(" ").join("."));

    $(matchingLines).each(function() {
      $(this).css("background-color", "white");
    })
  }
});
 
</script>
<div id="meta-card" class="container-fluid">
  <div class=row>
    <div class="col-md-6" id="detail-parent">
      <b> Original Source Code: </b> <span class="snippet-name"> </span> <br>
      <b> Author: </b> <span class="author"> </span> <br>
      <b> Creation Date: </b> <span class="created-date"> </span> <br><br>
      <div class="code-snippet">
        hi1
      </div>
    </div>
    <div class="col-md-6" id="detail-child">
      <b> Original Source Code: </b> <span class="snippet-name"> </span> <br>
      <b> Author: </b> <span class="author"> </span> <br>
      <b> Creation Date: </b> <span class="created-date"> </span> <br><br>
      <div class="code-snippet">
        hi2
      </div>
    </div>
  </div>
</div>
</body>
</html>