<script>
    //this is nice to have
    d3.selection.prototype.moveToFront = function() { 
      return this.each(function() { 
        this.parentNode.appendChild(this); 
      }); 
    };
  </script>
  
  <script>
    //active sticker is kept in this variable
    var sticker;
    var bbox;

    var toolbar = d3.select("#toolbar");
    var stickers = toolbar.selectAll(".sticker");
    function stickerPicker(d,i) {
      var el = d3.select(this).select("svg g").node();
      sticker = d3.sticker(el);
      console.log("sticker!", sticker);
      console.log("el", el)
      bbox = el.getBBox();

      stickers.classed("selected", false);
      d3.select(this).classed("selected", true);
    }
    stickers.on("click", stickerPicker);
    //pick first sticker by default
    stickerPicker.call(stickers.node(), null, 0);
    
    var svg = d3.select("#surface");
    svg.on("click", function() {
      var mouse = d3.mouse(this);
      mouse[0] -= bbox.width/2 + bbox.x;
      mouse[1] -= bbox.height/2 + bbox.y;
      //place the sticker centered
      sticker(svg)
        .attr("transform", "translate(" + mouse + ")");

      //we want our ghost to be on top all the time
      ghost.moveToFront();
    })

    var ghost;
    var mousedown = false;
    svg.on("mousedown", function() {
      mousedown = true;
    })
    svg.on("mouseup", function() {
      mousedown = false;
    })
    svg.on("mouseenter", function() {
      ghost = sticker(svg);
      ghost.style({
        opacity: 0.4,
        stroke: "#000",
        "stroke-width": 2,
        "stroke-dasharray": "2 2"
      });
    })
    svg.on("mouseleave", function() {
      mousedown = false;
      ghost.remove();
    })
    svg.on("mousemove", function() {
      var mouse = d3.mouse(this);
      mouse[0] -= bbox.width/2 + bbox.x;
      mouse[1] -= bbox.height/2 + bbox.y;
      ghost
        .attr("transform", "translate(" + mouse + ")");

      //continuously paste if mouse is held down
      if(mousedown) {
        sticker(svg)
          .attr("transform", "translate(" + mouse + ")");
        ghost.moveToFront()
      }
    })
    
  </script>