<script>
    function log(node_id){
        var node = document.getElementById(node_id);
        console.log('NODE: ', node_id);
        console.log('BBOX: ', node.getBBox());
        console.log('\tBBOX width: ', 
            node.getBBox().width, 
            ' | height: ', 
            node.getBBox().height);
        console.log('Computed text length: ', node.getComputedTextLength());
    }
    function pause(delay){
        var date = new Date();
        var curDate = null;
        do { curDate = new Date(); } 
        while(curDate-date < delay);
        console.log('done with pause')
    } 
    function create_nodes_blocking(delay){
        //Node 2 Auto create with EMs
        d3.select('#text_node_2').append('tspan')
            .text('You');
        pause(delay);
        d3.select('#text_node_2').append('tspan')
            .text('shall')
            .attr('dx', '.5em');
        d3.select('#text_node_2').append('tspan')
            .text('not')
            .attr('dx', '.5em')
            .attr('dy', '.9em');
        pause(delay);
        d3.select('#text_node_2').append('tspan')
            .text('pass')
            .attr('dx', '.5em')
            .attr('dy', '.9em');

        //Node 4 Auto create with EMs
        //NOTE: If this is in a function, it will NOT work
        pause(delay);
        d3.select('#text_node_4').append('tspan')
            .text('You');
        pause(delay);
        d3.select('#text_node_4').append('tspan')
            .text('shall')
            .attr('dx', '10px');
        pause(delay);
        d3.select('#text_node_4').append('tspan')
            .text('not')
            .attr('dx', '10px')
            .attr('dy', '20px');
        pause(delay);
        d3.select('#text_node_4').append('tspan')
            .text('pass')
            .attr('dx', '10px')
            .attr('dy', '20px');

        console.log('=======================================================');
        log('text_node_1');
        console.log('=======================================================');
        log('text_node_2');
        console.log('=======================================================');
        log('text_node_3');
        console.log('=======================================================');
        log('text_node_4');
    }
    //Will ALWAYS work on chrome dev
    //create_nodes(200);

    function create_nodes_non_blocking(delay){
        if(delay === undefined){var delay=200;}
        //Node 2 Auto create with EMs
        setTimeout(function(){d3.select('#text_node_2').append('tspan')
            .text('You');}, delay);
        setTimeout(function(){d3.select('#text_node_2').append('tspan')
            .text('shall')
            .attr('dx', '.5em');}, delay * 2);
        setTimeout(function(){d3.select('#text_node_2').append('tspan')
            .text('not')
            .attr('dx', '.5em')
            .attr('dy', '.9em');}, delay * 3);
        setTimeout(function(){d3.select('#text_node_2').append('tspan')
            .text('pass')
            .attr('dx', '.5em')
            .attr('dy', '.9em');}, delay * 4);

        //Node 4 Auto create with EMs
        //NOTE: If this is in a function, it will NOT work
        setTimeout(function(){d3.select('#text_node_4').append('tspan')
            .text('You');},delay * 5);
        setTimeout(function(){d3.select('#text_node_4').append('tspan')
            .text('shall')
            .attr('dx', '10px');},delay * 6);
        setTimeout(function(){d3.select('#text_node_4').append('tspan')
            .text('not')
            .attr('dx', '10px')
            .attr('dy', '20px');},delay * 7);
        setTimeout(function(){d3.select('#text_node_4').append('tspan')
            .text('pass')
            .attr('dx', '10px')
            .attr('dy', '20px');},delay * 8);

        setTimeout(function(){
            console.log('=======================================================');
            log('text_node_1');
            console.log('=======================================================');
            log('text_node_2');
            console.log('=======================================================');
            log('text_node_3');
            console.log('=======================================================');
            log('text_node_4');
        }, delay * 9);
    }

    //Events for buttons
    document.getElementById('render_nodes_blocking').addEventListener(
        'click',
        function(){
            create_nodes_blocking(
                parseFloat( (document.getElementById('pause_delay').value || 200), 10)
            );
        });
    document.getElementById('render_nodes_non_blocking').addEventListener(
        'click',
        function(){
            create_nodes_non_blocking(
                parseFloat( (document.getElementById('pause_delay').value || 200), 10)
            );
        });

    //NOTE: Calling non_blocking ALWAYS works (as long as delay is > 1ms)
</script>